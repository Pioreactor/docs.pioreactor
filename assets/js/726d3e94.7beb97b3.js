"use strict";(self.webpackChunkpioreactor=self.webpackChunkpioreactor||[]).push([[2114],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var r=a(67294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function n(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?n(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,r,o=function(e,t){if(null==e)return{};var a,r,o={},n=Object.keys(e);for(r=0;r<n.length;r++)a=n[r],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(r=0;r<n.length;r++)a=n[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var l=r.createContext({}),p=function(e){var t=r.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var a=e.components,o=e.mdxType,n=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(a),m=o,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||n;return a?r.createElement(h,i(i({ref:t},c),{},{components:a})):r.createElement(h,i({ref:t},c))}));function m(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var n=a.length,i=new Array(n);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var p=2;p<n;p++)i[p]=a[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,a)}u.displayName="MDXCreateElement"},95141:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>n,metadata:()=>s,toc:()=>p});var r=a(87462),o=(a(67294),a(3905));const n={title:"Data stores in the Pioreactor",slug:"/data-stores"},i=void 0,s={unversionedId:"Storage and the filesystem/data-stores",id:"Storage and the filesystem/data-stores",title:"Data stores in the Pioreactor",description:"The Pioreactor has a few different ways to store data (depending on the requirements). They are:",source:"@site/developer-guide/09-Storage and the filesystem/01-data-stores.md",sourceDirName:"09-Storage and the filesystem",slug:"/data-stores",permalink:"/developer-guide/data-stores",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Data stores in the Pioreactor",slug:"/data-stores"},sidebar:"tutorialSidebar",previous:{title:"Custom & additional pumps for dosing automations",permalink:"/developer-guide/writing-pump-software"},next:{title:"Important locations on the filesystem",permalink:"/developer-guide/filesystem-locations"}},l={},p=[{value:"SQLite3",id:"sqlite3",level:2},{value:"Backups of the database",id:"backups-of-the-database",level:4},{value:"Key-value datastore",id:"key-value-datastore",level:4},{value:"MQTT",id:"mqtt",level:2},{value:"Serialization of MQTT messages",id:"serialization-of-mqtt-messages",level:4},{value:"Authentication",id:"authentication",level:4}],c={toc:p};function d(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,r.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"The Pioreactor has a few different ways to store data (depending on the requirements). They are:"),(0,o.kt)("h2",{id:"sqlite3"},"SQLite3"),(0,o.kt)("p",null,"The most important datastore is the SQLite3 database on the ",(0,o.kt)("em",{parentName:"p"},"leader"),", located at ",(0,o.kt)("inlineCode",{parentName:"p"},"/home/pioreactor/.pioreactor/storage/"),". This database stores historical data, jobs changes, logs, experiments, etc. The background job ",(0,o.kt)("inlineCode",{parentName:"p"},"mqtt_to_database_streaming")," picks up data from MQTT (like OD readings), and puts them into the database."),(0,o.kt)("p",null,"The CLI command ",(0,o.kt)("inlineCode",{parentName:"p"},"pio db")," will open up the SQLite terminal to query the database directly."),(0,o.kt)("h4",{id:"backups-of-the-database"},"Backups of the database"),(0,o.kt)("p",null,"The Pioreactor software will automatically backup the SQLite database via a scheduale ",(0,o.kt)("inlineCode",{parentName:"p"},"cron")," job. The backup is hosted locally on the Raspberry Pi, however if there if the cluster has active worker Pioreactors, the database backup is duplicated to (at most) two workers as well. This level of redundancy means that if the leader's microSD card fails, the database can be recovered from backups stored off the card."),(0,o.kt)("h4",{id:"key-value-datastore"},"Key-value datastore"),(0,o.kt)("p",null,"SQLite3 is also used by the library ",(0,o.kt)("em",{parentName:"p"},"diskcache"),'. This is essentially a fast key-value store on the Raspberry Pi. For Pioreactor, we use it to store "machine-specific" data, like calibration curves, locks on GPIOs, state of LEDs, jobs running, etc. Instead of one large file containing all these keys, we have split them into multiple locations based on category and level of persistence. The persistent databases are stored in ',(0,o.kt)("inlineCode",{parentName:"p"},"/home/pioreactor/.pioreactor/storage")," and the temporary databases are in ",(0,o.kt)("inlineCode",{parentName:"p"},"/tmp"),". You can access them from Python using ",(0,o.kt)("inlineCode",{parentName:"p"},"pioreactor.utils.local_persistant_storage")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"pioreactor.utils.local_intermittent_storage"),", respectively."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"What are temporary and persistent? Something like GPIO locks or LED state are physically reset between cycles of the Raspberry Pi. So when the Pi power-cycles, the state is wiped, and by have the database in ",(0,o.kt)("inlineCode",{parentName:"p"},"/tmp"),", the databases are wiped as well.")),(0,o.kt)("p",null,"You can use ",(0,o.kt)("inlineCode",{parentName:"p"},"pio view-cache <name>")," to view the contents of ",(0,o.kt)("inlineCode",{parentName:"p"},"<name>"),"."),(0,o.kt)("h2",{id:"mqtt"},"MQTT"),(0,o.kt)("p",null,"The inter- and intra-Pioreactor communications are handled by MQTT, a pub/sub service. The MQTT broker is on the leader Pioreactor (",(0,o.kt)("inlineCode",{parentName:"p"},"pio mqtt")," will stream the latest messages to your terminal). MQTT is used to transfer data between workers and leader, and even between process on the workers (ex: OD readings are created on worker, send to leader, and then sent back to worker's growth_rate_calculating job. This does create minor latency, and certainly more risk of data loss, but simplifies the design of the system overall)."),(0,o.kt)("p",null,"A principle we have stood by is to not let MQTT turn into our database. That is,"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"we shouldn't store important information in MQTT ",(0,o.kt)("em",{parentName:"li"},"only"),","),(0,o.kt)("li",{parentName:"ol"},'we shouldn\'t store information in MQTT that is "machine-specific",'),(0,o.kt)("li",{parentName:"ol"},"we shouldn't use MQTT as a source of truth.")),(0,o.kt)("h4",{id:"serialization-of-mqtt-messages"},"Serialization of MQTT messages"),(0,o.kt)("p",null,"Every 25 minutes (set by the MQTT configuration file), MQTT will serialize its ",(0,o.kt)("em",{parentName:"p"},"retained")," messages to disk."),(0,o.kt)("h4",{id:"authentication"},"Authentication"),(0,o.kt)("p",null,"The Mosquitto broker has a username/password of ",(0,o.kt)("inlineCode",{parentName:"p"},"pioreactor")," / ",(0,o.kt)("inlineCode",{parentName:"p"},"raspberry"),"."))}d.isMDXComponent=!0}}]);