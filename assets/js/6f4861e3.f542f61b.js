"use strict";(self.webpackChunkpioreactor=self.webpackChunkpioreactor||[]).push([[2057],{62195:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>l});var s=t(85893),o=t(11151);const i={title:"Introduction to background jobs",slug:"/intro-background-jobs",hide_table_of_contents:!0},a=void 0,r={id:"Background jobs/intro-background-jobs",title:"Introduction to background jobs",description:'The core unit of "work" in the Pioreactor software is a background job (called activities in the web interface). Background jobs include odreading, monitor, automation controllers, all the automations_ themselves, etc. Often, a community plugin is a background job (or multiple jobs) that gives your bioreactor new abilities. There are a few important features of background jobs to be highlighted if you intend on working with them.',source:"@site/developer-guide/03-Background jobs/01-intro-background-jobs.md",sourceDirName:"03-Background jobs",slug:"/intro-background-jobs",permalink:"/developer-guide/intro-background-jobs",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Introduction to background jobs",slug:"/intro-background-jobs",hide_table_of_contents:!0},sidebar:"tutorialSidebar",previous:{title:"Important concepts",permalink:"/developer-guide/important-concepts"},next:{title:"Writing a custom background job",permalink:"/developer-guide/writing-background-jobs"}},c={},l=[{value:"Inheritance and file structure",id:"inheritance-and-file-structure",level:3},{value:"Logging",id:"logging",level:3},{value:"State of a job",id:"state-of-a-job",level:3},{value:"Publish &amp; subscribe, also known as pub/sub",id:"publish--subscribe-also-known-as-pubsub",level:3},{value:"Publishing attributes to MQTT",id:"publishing-attributes-to-mqtt",level:3},{value:"Uniqueness",id:"uniqueness",level:3},{value:"Entry &amp; exit",id:"entry--exit",level:3},{value:"Blocking",id:"blocking",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:['The core unit of "work" in the Pioreactor software is a background job (called ',(0,s.jsx)(n.em,{children:"activities"})," in the web interface). Background jobs include ",(0,s.jsx)(n.code,{children:"od_reading"}),", ",(0,s.jsx)(n.code,{children:"monitor"}),", automation controllers, all the ",(0,s.jsx)(n.em,{children:"automations"})," themselves, etc. Often, a community plugin is a background job (or multiple jobs) that gives your bioreactor new abilities. There are a few important features of background jobs to be highlighted if you intend on working with them."]}),"\n",(0,s.jsx)(n.h3,{id:"inheritance-and-file-structure",children:"Inheritance and file structure"}),"\n",(0,s.jsxs)(n.p,{children:["All background jobs inherit from the base class ",(0,s.jsx)(n.code,{children:"pioreactor.background_jobs.base.BackgroundJob"}),". This class controls most of the behind-the-scenes behaviour of the class."]}),"\n",(0,s.jsxs)(n.p,{children:["Typically, we structure background job code such that the Python file has a single background job class and a command-line interface. See examples ",(0,s.jsx)(n.a,{href:"https://github.com/Pioreactor/pioreactor/tree/master/pioreactor/background_jobs",children:"here"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"logging",children:"Logging"}),"\n",(0,s.jsxs)(n.p,{children:["All subclasses of ",(0,s.jsx)(n.code,{children:"BackgroundJob"})," have the ",(0,s.jsx)(n.code,{children:"logger"})," attribute that can be used to log messages. These messages are printed to the console, sent to MQTT, ",(0,s.jsx)(n.em,{children:"sometimes"})," displayed in the UI, and all are stored permanently in the Pioreactor database. Here's how:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'\n# use for debugging\njob.logger.debug("A debug message - displayed in the console")\n\n# use for providing relevant updates\njob.logger.info("An info message - this is display in the Recent Logs table in the UI")\n\n# use for successes or important updates\njob.logger.notice("A notice message - this is displayed in the UI in a green popup")\n\n# use for when something doesn\'t look correct, but will continue.\njob.logger.warning("A debug message - this is displayed in the UI in a yellow popup")\n\n# use for when something is wrong and you take over control from the user\njob.logger.error("A debug message - this is displayed in the UI in a red popup")\n'})}),"\n",(0,s.jsx)(n.h3,{id:"state-of-a-job",children:"State of a job"}),"\n",(0,s.jsx)(n.p,{children:"A background job can be in one of five different states:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"init"}),": the job is initializing. The job starts in this state."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ready"}),': the job is prepared to do "work", or currently doing "work"']}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"sleeping"}),": the job's work is paused (ex: when the stirring job is in state ",(0,s.jsx)(n.code,{children:"sleeping"}),', it turns off its power.) This state is called "paused" in the web interface.']}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"disconnected"}),": the job has disconnected from services (MQTT, databases, etc.) and cleaned itself up successfully."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"lost"}),": the job did not disconnect gracefully. Something may be wrong."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Here's how the states can transition to each other:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"                                        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                                        \u2502          \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba   lost   \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502                      \u2502       \u2502          \u2502        \u2502\n         \u2502                      \u2502       \u2514\u2500\u2500\u2500\u2500\u2500\u25b2\u2500\u2500\u2500\u2500\u2518        \u2502\n         \u2502                      \u2502             \u2502             \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u2502     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502          \u2502          \u2502            \u2502      \u2502     \u2502              \u2502\n    \u2502   init   \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba    ready   \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u25ba disconnected \u2502\n    \u2502          \u2502          \u2502            \u2502      \u2502     \u2502              \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u25b2\u2500\u2500\u2500\u2500\u2518      \u2502     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u25b2\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                               \u2502  \u2502           \u2502            \u2502\n                               \u2502  \u2502           \u2502            \u2502\n                               \u2502  \u2502           \u2502            \u2502\n                          \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2502\n                          \u2502            \u2502                   \u2502\n                          \u2502  sleeping  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                          \u2502            \u2502\n                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The author can optionally define hooks when a job moves between states, and when it enters a new state. For example, the method ",(0,s.jsx)(n.code,{children:".on_ready_to_sleeping()"})," is called when the job moves from ",(0,s.jsx)(n.code,{children:"ready"})," to ",(0,s.jsx)(n.code,{children:"sleeping"}),". Similarly, the method ",(0,s.jsx)(n.code,{children:".on_sleeping()"})," is called when the jobs enters state ",(0,s.jsx)(n.code,{children:"sleeping"}),". By default, these methods are empty."]}),"\n",(0,s.jsxs)(n.p,{children:["The recommended way to move a job between states is with ",(0,s.jsx)(n.code,{children:"job.set_state(job.READY)"}),". This will invoke any hooks that exist between the states. State can also be changed remotely over MQTT - we'll get to that point later."]}),"\n",(0,s.jsx)(n.h3,{id:"publish--subscribe-also-known-as-pubsub",children:"Publish & subscribe, also known as pub/sub"}),"\n",(0,s.jsxs)(n.p,{children:["On job creation, the job will connect to ",(0,s.jsx)(n.a,{href:"/developer-guide/important-concepts#mqtt",children:"MQTT"})," to allow for publishing and subscribing. The attribute ",(0,s.jsx)(n.code,{children:"sub_client"})," is for subscribing from MQTT, and ",(0,s.jsx)(n.code,{children:"pub_client"})," is for publishing to MQTT. Internally, ",(0,s.jsx)(n.code,{children:"sub_client"})," and ",(0,s.jsx)(n.code,{children:"pub_client"})," are ",(0,s.jsx)(n.a,{href:"https://github.com/eclipse/paho.mqtt.python/blob/master/src/paho/mqtt/client.py",children:"Paho client objects"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Since publishing is so common, we also expose a ",(0,s.jsx)(n.code,{children:".publish"})," method:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'job = SomeBackgroundJob(unit, experiment)\njob.publish(f"pioreactor/{job.unit}/{job.experiment}/...", payload)\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Another common pattern is to subscribe to a MQTT topic, and execute a threaded callback whenever a message comes in from that topic. This is done with the ",(0,s.jsx)(n.code,{children:".subscribe_and_callback"})," method. By convention, this is most often used in a ",(0,s.jsx)(n.code,{children:".start_passive_listeners"})," method:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from pioreactor.background_jobs.base import BackgroundJob\n\nclass SomeBackgroundJob(BackgroundJob):\n\n    def __init__(self, ...):\n        ...\n\n        self.start_passive_listeners()\n\n\n    def response_to_dosing_event(self, msg):\n        # change self in response, etc.\n        ...\n\n    def start_passive_listeners(self):\n        self.subscribe_and_callback(\n            self.response_to_dosing_event,\n            f"pioreactor/{self.unit}/{self.experiment}/dosing_events",\n        )\n\n'})}),"\n",(0,s.jsx)(n.h3,{id:"publishing-attributes-to-mqtt",children:"Publishing attributes to MQTT"}),"\n",(0,s.jsx)(n.p,{children:"A common task is when we have a job running, say stirring job, and we want to dynamically update an attribute, like the target RPM, without restarting the job."}),"\n",(0,s.jsxs)(n.p,{children:["We also want to know the value of a job's attribute when it changes. For example, in the stirring job, we'd like to know what the ",(0,s.jsx)(n.em,{children:"actual"})," RPM is. This can't be edited externally (it's a measured value...), but we want the value available for other jobs to use, for the web interface to display, or to sink it into a database."]}),"\n",(0,s.jsxs)(n.p,{children:["These two tasks, updating attributes and reading attributes in real-time, are so common that we've wrapped the logic into the parent ",(0,s.jsx)(n.code,{children:"BackgroundJob"})," class, and allow job authors to tell us what attributes they wish to update and/or read."]}),"\n",(0,s.jsxs)(n.p,{children:["In the class definition, the attribute ",(0,s.jsx)(n.code,{children:"published_settings"})," defines which class attributes they would like to track. For example, the job responsible for stirring looks like:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'class Stirrer(BackgroundJob):\n\n    published_settings = {\n        "target_rpm":   {"datatype": "json",  "settable": True,  "unit": "RPM"},\n        "measured_rpm": {"datatype": "json",  "settable": False, "unit": "RPM"},\n        "duty_cycle":   {"datatype": "float", "settable": True,  "unit": "%"},\n    }\n\n    ...\n\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Thus the attributes ",(0,s.jsx)(n.code,{children:"target_rpm"}),", ",(0,s.jsx)(n.code,{children:"measured_rpm"}),", ",(0,s.jsx)(n.code,{children:"duty_cycle"})," are all published to MQTT when they change, but only ",(0,s.jsx)(n.code,{children:"duty_cycle"})," and ",(0,s.jsx)(n.code,{children:"target_rpm"})," are able to be updated over MQTT (as defined by ",(0,s.jsx)(n.code,{children:"settable"}),")."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:'"datatype"'})," field is normally one of: ",(0,s.jsx)(n.code,{children:'"string"'}),", ",(0,s.jsx)(n.code,{children:'"float"'}),", ",(0,s.jsx)(n.code,{children:'"integer"'}),", ",(0,s.jsx)(n.code,{children:'"json"'}),", ",(0,s.jsx)(n.code,{children:'"boolean"'})," (full list in ",(0,s.jsx)(n.code,{children:"pioreactor/types.py"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:'"settable"'})," field sets whether this attribute can be changed externally."]}),"\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:'"unit"'})," field is the unit of measurement, if any. This key is optional, and can be omitted."]}),"\n",(0,s.jsxs)(n.li,{children:["Also, there is an optional ",(0,s.jsx)(n.code,{children:'"persist"'})," key (not shown above), which contains a boolean describing if the value should be kept in MQTT after the job exits, default ",(0,s.jsx)(n.code,{children:"False"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["When a class' attribute that's present in ",(0,s.jsx)(n.code,{children:"published_settings"})," changes, a MQTT message is published under the topic ",(0,s.jsx)(n.code,{children:"pioreactor/{self.unit}/{self.experiment}/{self.job_name}/{attr}"})," with payload equal to the new value of the attribute. This is how the web interface is provided real-time data."]}),"\n",(0,s.jsxs)(n.p,{children:["For updating an attribute, the ",(0,s.jsx)(n.code,{children:"BackgroundJob"})," parent class listens to the MQTT topic:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pioreactor/{self.unit}/{self.experiment}/{self.job_name}/+/set\n"})}),"\n",(0,s.jsxs)(n.p,{children:["(the ",(0,s.jsx)(n.code,{children:"+"})," is a MQTT wildcard), and when a message comes in, the class will check if the attribute (defined by ",(0,s.jsx)(n.code,{children:"+"}),") is ",(0,s.jsx)(n.code,{children:"settable"}),". If so, a lookup is done to see if a class method called ",(0,s.jsx)(n.code,{children:"set_<attr>"})," is defined, and if present, calls that, with the only argument the message's payload. Otherwise, a simple assignment is done: ",(0,s.jsx)(n.code,{children:"self.<attr> = payload"}),". The utility of a ",(0,s.jsx)(n.code,{children:"set_<attr>"})," method is when changing the attribute requires more logic (ex: changing a PID controller's set point, see ",(0,s.jsx)(n.a,{href:"https://github.com/Pioreactor/pioreactor/blob/2d26082b85e06114b1847f11ffd28fd86453cf7f/pioreactor/background_jobs/stirring.py#L382-L385",children:"example here"}),")."]}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"state"})," is special attribute that is automatically appended to ",(0,s.jsx)(n.code,{children:"published_settings"})," (with ",(0,s.jsx)(n.code,{children:"settable: True"})," and ",(0,s.jsx)(n.code,{children:"persist: True"}),") so the state of the job can always be updated and read from MQTT. Over MQTT, the field is called referenced as ",(0,s.jsx)(n.code,{children:"pioreactor/{unit}/{experiment}/{job_name}/$state"})," - note the ",(0,s.jsx)(n.code,{children:"$"}),"."]})}),"\n",(0,s.jsxs)(n.p,{children:["When the job disconnects and cleans up, the published settings in MQTT are removed by sending an empty payload to the respective topics (unless ",(0,s.jsx)(n.code,{children:"persist: True"}),", see above.)"]}),"\n",(0,s.jsx)(n.h3,{id:"uniqueness",children:"Uniqueness"}),"\n",(0,s.jsxs)(n.p,{children:["Only a single instance of a background job, indexed by the job's name, can be running on a Raspberry Pi. For example, only a single ",(0,s.jsx)(n.code,{children:"Monitor"})," background job can run, likewise only a single ",(0,s.jsx)(n.code,{children:"ODReading"})," can run. (It's not clear what running multiple ",(0,s.jsx)(n.code,{children:"ODReading"}),"s means, or how they will interact with the hardware - poorly we expect)."]}),"\n",(0,s.jsxs)(n.p,{children:["The uniqueness is across processes, too. So if a script is running ",(0,s.jsx)(n.code,{children:"ODReading"}),", then ",(0,s.jsx)(n.code,{children:"pio run od_reading"})," will fail."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"This uniqueness constraint is enforced in the current version of the software. It's possible we will see a reason to remove the uniqueness constraint in a future version - let us know if you want to see this, too!"})}),"\n",(0,s.jsx)(n.h3,{id:"entry--exit",children:"Entry & exit"}),"\n",(0,s.jsx)(n.p,{children:"Background jobs make lots of connections to MQTT, GPIOs, hardware, and other external systems. It's important to treat background jobs as objects that need to be cleaned up these connections properly."}),"\n",(0,s.jsxs)(n.p,{children:["If your jobs needs to clean up something, you can put it into the ",(0,s.jsx)(n.code,{children:"on_disconnected"})," function:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from pioreactor.background_jobs.base import BackgroundJob\nfrom pioreactor.actions.led_intensity import led_intensity\n\nclass HappyJob(BackgroundJob):\n\n    def __init__(self, ...):\n        # connect to a hardware\n        self.hardware_connection = Hardware()\n        self.hardware_connection.connect()\n\n        # set LED on, too\n        led_intensity({"A": 10})\n\n\n    def on_disconnected(self):\n        self.hardware_connection.disconnect()\n        led_intensity({"A": 0})\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"on_disconnected"})," is called and connections are closed when the job exits (see below)."]}),"\n",(0,s.jsx)(n.p,{children:"There are two ways to use a background job that will ensure jobs are cleaned up correctly on exit:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"job = SomeBackgroundJob(unit, experiment)\n...\njob.clean_up()\n# all cleaned up - state is set to disconnected\n"})}),"\n",(0,s.jsx)(n.p,{children:"alternatively, with a context manager:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"with SomeBackgroundJob(unit, experiment) as job:\n  ...\n\n# all cleaned up - state is set to disconnected\n"})}),"\n",(0,s.jsx)(n.p,{children:"The job is also cleaned up when the Python process exits."}),"\n",(0,s.jsxs)(n.admonition,{type:"caution",children:[(0,s.jsx)(n.p,{children:"The following will cause problems:"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"#\u274c don't do this\ndef function_that_doesnt_clean_up():\n    job = SomeBackgroundJob(unit, experiment)\n    # job not cleaned up\n    return True\n\nvalue = function_that_doesnt_clean_up()\n...\n"})}),(0,s.jsxs)(n.p,{children:["In the above, the job ",(0,s.jsx)(n.code,{children:"SomeBackgroundJob"})," isn't disconnected, and state hasn't changed - nor can you access the job anymore (no accessible references). Do this instead:"]}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"# \u2705 this is okay\ndef function_that_does_clean_up():\n    with SomeBackgroundJob(unit, experiment) as job:\n        ...\n    return True\n\nvalue = function_that_does_clean_up()\n"})}),(0,s.jsx)(n.h3,{id:"blocking",children:"Blocking"}),(0,s.jsx)(n.p,{children:"Often we want the job to wait and blocks, so as to wait for user commands or MQTT messages. We can accomplish this with"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"job.block_until_disconnected()\n"})}),(0,s.jsx)(n.p,{children:"This blocks the execution until the job is disconnected (either a MQTT state change, or a signal from the OS)."})]})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>r,a:()=>a});var s=t(67294);const o={},i=s.createContext(o);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);